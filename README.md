# 武大超算组内用户资源配置与软件使用

现在，组里的武大超算用户已经全部加入付费账户sjyuan之下，包括
- weiqingzhou_2017
- pflv
- xtyang
- plzhao
- hxzhong
- zwwu
- zhanzhen
- wqxiong
- kxhuang
- xhkuang
- jose
- gdyu

那么，我们经过这次配置之后，**所有人都只用自己的帐号计算，除去目前还在跑的计算，不要再用袁老师帐号提交任何计算！！**

## 1. 初始化配置

首先，请删除自己目录下的`.bash_profile`文件(`rm -f .bash_profile`)，将所有自定义的指令、别名等放到文件`.bashrc`中，并自行删除`.bashrc`里与`module`以及`python`有关的全部内容(包括个人的environment，因为我们已经换用`PYTHONUSERBASE`环境来隔离系统路径，除非需要同时用到2.x与3.x的python，否则不建议使用environment)。

然后，在自己的目录下运行
```bash
/home/sjyuan/bin/init.sh
```
命令运行完之后，重新登录自己的超算，所有的环境就已经配置好了。

注意，这个命令会给你自己的账户下安装`matplotlib`和`h5py`包，因为这两个包是现在python版tipsi软件所需要的。以后，如果需要安装PYPI库里有的python包，例如`pymatgen`、`phonopy`、`pycuda`、`custodian`、`monty`等等，都可以用命令
```bash
pip install --user 包名称
```
来进行安装。

## 2. 任务提交方法

现在，我们**不要再用复制文件、修改并运行的方法提交任务**，现在新的提交任务方式改成直接使用指令的方式，指令包括
- submit.serial (提交单核的程序)
- submit.omp    (提交OpenMP多线程并行程序)
- submit.mpi    (提交MPI多任务并行程序)
- submit.loop   (利用循环提交一连串相关的任务) [待实现]
- submit.hybrid (提交MPI与OpenMP混合并行的程序) [待实现]
- submit.gpu    (提交GPU计算的程序) [待实现]

而可以使用的软件，我现在全部做成module包的形式，具体有哪些软件可以使用，大家可以输入`module avail`来查看。

任务提交方式举例如下(注意，其中`module load 包名`语句，每次登录后只要执行一次就行，故可以将常用或必须的模块写入`.bashrc`中。并且，**所有的submit前都不用加./**)，这几个指令的文件都在本repository中，有兴趣的同学可以参考学习一下。
### (1) 提交MPI程序(以vasp为例)
```bash
module load vasp
submit.mpi -J 任务名 vasp
```
**`-J`中的字母J必须大写！！！**

以上为*默认提交方式*，默认的提交方式是**向不收费的节点提交16核的任务**，即对应
```bash
submit.mpi -p free -n 16 -J 任务名 可执行程序
```
其中，`-J`(或`--job-name`)后指定任务名，任务名必须指定，否则这个指令会报错无法执行，`-p`(或`--partition`)后指定提交的节点，默认为`free`。[**注意：只有`free`节点为不收费的节点，直接写`hpxg`节点，会提交到收费账户的`hpxg`节点下**]，`-n`(或`--ntasks`)后指定MPI任务数，在此处就是计算用的总核数，默认为16。

`submit.mpi`的可选参数还包括
```
-N(或--nodes) 节点数[,节点数]   如果指定一个数，即必须在这么多个节点上计算，而给定两个数表示最少到最多的节点数。如果没有特殊需要，通常不用设置这个参数。
--exclusive                   独占某个节点，即这个节点只能你一个人的这个任务跑，你计算的过程中其他人无法将任务提交到这个节点
```

### (2) 提交OpenMP程序(以tipsi为例)
```bash
module load tipsi/stable
submit.omp -J 任务名 python 文件名
```
**`-J`中的字母J必须大写！！！**

以上为*默认提交方式*，默认的提交方式是**向不收费的节点提交16核的任务**，即对应
```bash
submit.omp -p free -c 16 -J 任务名 可执行程序
```
其中，`-J`(或`--job-name`)后指定任务名，任务名必须指定，否则这个指令会报错无法执行，`-p`(或`--partition`)后指定提交的节点，默认为`free`。[**注意：只有`free`节点为不收费的节点，直接写`hpxg`节点，会提交到收费账户的`hpxg`节点下**]，`-c`(或`--cpus_per_task`)后指定OpenMP线程数，在此处就是计算用的总核数，默认为16。

`submit.omp`的可选参数还包括
```
--exclusive     独占某个节点，即这个节点只能你一个人的这个任务跑，你计算的过程中其他人无法将任务提交到这个节点
```

### (3) 提交单核程序(通常为一些需要花时间的数据处理程序，或者自己写的无并行程序)
```bash
submit.serial -J 任务名 可执行程序
```
**`-J`中的字母J必须大写！！！**

以上为*默认提交方式*，默认的提交方式是**向不收费的节点提交的任务**，即对应
```bash
submit.serial -p free -J 任务名 可执行程序
```
其中，`-J`(或`--job-name`)后指定任务名，任务名必须指定，否则这个指令会报错无法执行，`-p`(或`--partition`)后指定提交的节点，默认为`free`。[**注意：只有`free`节点为不收费的节点，直接写`hpxg`节点，会提交到收费账户的`hpxg`节点下**]。

## 3. 软件管理以及tipsi开发进度

目前超算上的软件，我已经全部做成module供大家加载，大家按需加载，部分module之间可能会存在冲突，如果出现问题尽量问我。

而，武大超算上的tipsi软件，目前分为tipsi/stable、tipsi/dev、tipsi-pro三种，其中前两种是目前广泛使用的基于python的软件，stable版本只进行bug修复，如果这个版本有大的更新，我会跟大家说明；而dev版本会按照需求加入新的功能。

至于tipsi-pro，目前已经可以进行计算了，可以算能带与DOS，所有部分的速度均比python版本快，包括但不限于
- 优化底层propagation的计算逻辑与并行分配，计算资源全部利用上，相比之前有10%性能提升
- 利用多线程并行构建sample，更稳定速度更快，计算速度达到数量级的提升且内存占用只需要原来的1/3到1/100，但目前暂时不计算坐标位置，故暂时无法加磁场、算AC等等
- 优化全局的输入、输出部分，原python版本在读写中有严重影响计算性能的地方，已经进行了优化。但目前读文件速度依然过慢，我正在将里面一处O(n)复杂度的计算改为O(1)的高效算法，但实现之后，TB模型只能最多达到第4096层近邻，同时单个元胞内最多可以拥有2^25约为三千万个orbital(最终sample中可含有总orbital数不受影响)。只有引入这一限制，才能运用高效且正确的hash校验算法构建sample。[实际上在之前python程序中默认含有这部分，但因为没有限制，当sample过大后有概率出错，此时将搜索算法的O(1)换为O(n)保证正确，这是原来建大sample慢的一个重要原因]
